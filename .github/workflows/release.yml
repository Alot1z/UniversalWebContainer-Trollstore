name: Release Universal WebContainer

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      release_version:
        description: 'Release version'
        required: true
        default: 'v1.0.0'
        type: string

jobs:
  create-release:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.2'

      - name: Install ldid
        run: |
          brew install ldid

      - name: Build Universal IPA
        run: |
          xcodebuild -workspace UniversalWebContainer.xcworkspace \
            -scheme UniversalWebContainer \
            -configuration Release \
            -destination 'generic/platform=iOS' \
            -archivePath build/UniversalWebContainer.xcarchive \
            archive

      - name: Export Universal IPA
        run: |
          xcodebuild -exportArchive \
            -archivePath build/UniversalWebContainer.xcarchive \
            -exportPath build/ \
            -exportOptionsPlist exportOptions-universal.plist

      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            build/UniversalWebContainer.ipa
          body: |
            ## ðŸš€ Universal WebContainer Release
            
            ### ðŸ“± Features
            - âœ… Universal IPA for all iOS versions (15.0-17.0)
            - âœ… TrollStore compatibility
            - âœ… Smart environment detection
            - âœ… Advanced session management
            - âœ… Offline support
            
            ### ðŸ”§ Installation
            1. Download the IPA file
            2. Install via AltStore, Sideloadly, or TrollStore
            3. Trust developer certificate in Settings
            
            ### ðŸŽ¯ Compatibility
            - **iOS 15.0-17.0**: Full support
            - **Standard iOS**: Basic features
            - **TrollStore**: Advanced features
            - **Jailbreak**: Enhanced capabilities
            
            ### ðŸ“Š Build Info
            - **Build Date**: ${{ github.event.release.published_at }}
            - **Commit**: ${{ github.sha }}
            - **Version**: ${{ github.event.inputs.release_version || github.event.release.tag_name }}
            
            ### ðŸ”’ Security
            - Hardware fingerprinting
            - IP-based authorization
            - Environment key validation
            - Secure local builder system
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
