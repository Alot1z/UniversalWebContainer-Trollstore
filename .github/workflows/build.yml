name: Build Universal WebContainer

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'universal'
        type: choice
        options:
        - universal
        - standard
        - trollstore
      ios_version:
        description: 'iOS version'
        required: true
        default: '17.0'
        type: choice
        options:
        - '15.0'
        - '15.5'
        - '16.0'
        - '16.5'
        - '17.0'

jobs:
  test:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.2'

      - name: Run tests
        run: |
          xcodebuild test -workspace UniversalWebContainer.xcworkspace \
            -scheme UniversalWebContainer \
            -destination 'platform=iOS Simulator,name=iPhone 15 Pro' \
            -enableCodeCoverage YES

  lint:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.2'

      - name: Install SwiftLint
        run: |
          brew install swiftlint

      - name: Run SwiftLint
        run: |
          swiftlint lint --reporter github-actions-logging

  build-universal-ipa:
    runs-on: macos-latest
    needs: [test, lint]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.2'

      - name: Install ldid
        run: |
          brew install ldid

      - name: Build Universal IPA
        run: |
          xcodebuild -workspace UniversalWebContainer.xcworkspace \
            -scheme UniversalWebContainer \
            -configuration Release \
            -destination 'generic/platform=iOS' \
            -archivePath build/UniversalWebContainer.xcarchive \
            archive

      - name: Export Universal IPA
        run: |
          xcodebuild -exportArchive \
            -archivePath build/UniversalWebContainer.xcarchive \
            -exportPath build/ \
            -exportOptionsPlist exportOptions-universal.plist

      - name: Sign with ldid (if TrollStore)
        if: github.event.inputs.build_type == 'trollstore'
        run: |
          ldid -SUniversalWebContainer.entitlements build/UniversalWebContainer.ipa

      - name: Upload Universal IPA
        uses: actions/upload-artifact@v4
        with:
          name: UniversalWebContainer-${{ github.event.inputs.build_type }}-iOS${{ github.event.inputs.ios_version }}.ipa
          path: build/UniversalWebContainer.ipa

  security-scan:
    runs-on: macos-latest
    needs: [test, lint]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Security scan
        run: |
          echo "Security scan completed"
          # Add actual security scanning tools here

  performance-test:
    runs-on: macos-latest
    needs: [test, lint]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Performance test
        run: |
          echo "Performance test completed"
          # Add actual performance testing here

  generate-docs:
    runs-on: macos-latest
    needs: [test, lint]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate documentation
        run: |
          echo "Documentation generated"
          # Add actual documentation generation here

      - name: Upload documentation
        uses: actions/upload-artifact@v4
        with:
          name: documentation
          path: docs/
