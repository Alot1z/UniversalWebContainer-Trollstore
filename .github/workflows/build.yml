name: Build Universal WebContainer

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'universal'
        type: choice
        options:
        - universal
        - trollstore
        - standard

jobs:
  detect-environment:
    runs-on: ubuntu-latest
    outputs:
      build-type: ${{ steps.detect.outputs.build-type }}
    steps:
      - uses: actions/checkout@v4
      - name: Detect Build Type
        id: detect
        run: |
          if [ "${{ github.event.inputs.build_type }}" != "" ]; then
            echo "build-type=${{ github.event.inputs.build_type }}" >> $GITHUB_OUTPUT
          else
            echo "build-type=universal" >> $GITHUB_OUTPUT
          fi

  build-universal:
    needs: detect-environment
    runs-on: macos-latest
    strategy:
      matrix:
        xcode: ['15.2']
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ matrix.xcode }}
      
      - name: Cache Xcode
        uses: actions/cache@v4
        with:
          path: ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-xcode-${{ matrix.xcode }}-${{ hashFiles('**/*.xcodeproj') }}
          restore-keys: |
            ${{ runner.os }}-xcode-${{ matrix.xcode }}-
      
      - name: Build Universal IPA
        run: |
          echo "üöÄ Building Universal WebContainer IPA..."
          echo "üì± Build Type: ${{ needs.detect-environment.outputs.build-type }}"
          
          # Build archive
          xcodebuild -project UniversalWebContainer.xcodeproj \
            -scheme UniversalWebContainer \
            -configuration Release \
            -archivePath UniversalWebContainer.xcarchive \
            archive
          
          # Export with universal options
          xcodebuild -exportArchive \
            -archivePath UniversalWebContainer.xcarchive \
            -exportPath ./builds \
            -exportOptionsPlist exportOptions-universal.plist
          
          echo "‚úÖ Build completed successfully!"
      
      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: UniversalWebContainer-${{ needs.detect-environment.outputs.build-type }}-${{ github.run_number }}
          path: ./builds/*.ipa
          retention-days: 30
      
      - name: Create Release
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          files: ./builds/*.ipa
          tag_name: v${{ github.run_number }}
          name: Universal WebContainer v${{ github.run_number }}
          body: |
            üöÄ Universal WebContainer v${{ github.run_number }}
            
            ## üîß Build Type: ${{ needs.detect-environment.outputs.build-type }}
            
            ### üì± Features:
            - ‚úÖ Universal IPA (Works on all devices)
            - ‚úÖ Automatic environment detection
            - ‚úÖ TrollStore compatibility
            - ‚úÖ Jailbreak detection (roothide/Nathan)
            - ‚úÖ Smart feature activation
            
            ### üéØ Installation:
            1. Download the IPA file
            2. Install via your preferred method:
               - **Standard**: AltStore, Sideloadly, 3uTools
               - **TrollStore**: Direct installation
               - **Jailbreak**: Direct installation
            
            ### üîç Environment Detection:
            The app automatically detects your environment and activates appropriate features:
            - **Standard iOS**: Basic features
            - **TrollStore**: Advanced features + browser import
            - **Jailbreak**: All features + system integration
            
            ---
            *Built with ‚ù§Ô∏è using GitHub Actions*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
